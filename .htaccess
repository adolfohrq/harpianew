# =============================================================================
# HTACCESS OTIMIZADO PARA REACT SPA - HOSTINGER + CLOUDFLARE
# Domínio: agenciaharpia.com.br
# Última atualização: 2025-11-30
# =============================================================================

# Desabilitar processamento PHP (não precisamos, é SPA estático)
<IfModule mod_php.c>
  php_flag engine off
</IfModule>

# -----------------------------------------------------------------------------
# CLOUDFLARE - Restaurar IP real do visitante
# -----------------------------------------------------------------------------
<IfModule mod_remoteip.c>
  RemoteIPHeader CF-Connecting-IP
</IfModule>

# -----------------------------------------------------------------------------
# SEGURANÇA - Bloquear acesso a arquivos sensíveis
# -----------------------------------------------------------------------------
<FilesMatch "(^\.env|\.env\.|\.git|\.htaccess|composer\.|package\.json|package-lock\.json|tsconfig\.json|vite\.config\.)">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order allow,deny
    Deny from all
  </IfModule>
</FilesMatch>

# Bloquear acesso a diretórios ocultos
<IfModule mod_rewrite.c>
  RewriteRule "(^|/)\.(?!well-known)" - [F]
</IfModule>

# -----------------------------------------------------------------------------
# REDIRECIONAMENTOS
# -----------------------------------------------------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Forçar HTTPS (compatível com Cloudflare)
  # Cloudflare envia X-Forwarded-Proto para indicar protocolo original
  RewriteCond %{HTTP:X-Forwarded-Proto} !https
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # Redirecionar www para non-www
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

  # SPA fallback - redireciona rotas para index.html
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ index.html [L]
</IfModule>

# -----------------------------------------------------------------------------
# PROTEÇÃO CONTRA HOTLINKING (imagens e vídeos)
# -----------------------------------------------------------------------------
<IfModule mod_rewrite.c>
  RewriteCond %{HTTP_REFERER} !^$
  RewriteCond %{HTTP_REFERER} !^https?://(www\.)?agenciaharpia\.com\.br [NC]
  RewriteCond %{HTTP_REFERER} !^https?://(.*\.)?cloudflare\.com [NC]
  RewriteCond %{HTTP_REFERER} !^https?://(.*\.)?google\. [NC]
  RewriteCond %{HTTP_REFERER} !^https?://(.*\.)?googleusercontent\.com [NC]
  RewriteRule \.(mp4|webm|webp|png|jpg|jpeg|gif|svg)$ - [F,L]
</IfModule>

# -----------------------------------------------------------------------------
# CACHE DE ASSETS
# Cloudflare respeita esses headers e os propaga para o edge
# -----------------------------------------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML - sem cache (sempre buscar do servidor)
  ExpiresByType text/html "access plus 0 seconds"

  # CSS e JS com hash no nome - cache longo
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"

  # Imagens (incluindo AVIF)
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType image/vnd.microsoft.icon "access plus 1 year"

  # Fontes
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"

  # Vídeos
  ExpiresByType video/mp4 "access plus 1 year"
  ExpiresByType video/webm "access plus 1 year"

  # Outros
  ExpiresByType application/json "access plus 0 seconds"
  ExpiresByType application/xml "access plus 1 hour"
</IfModule>

# Cache-Control headers com stale-while-revalidate
<IfModule mod_headers.c>
  # Assets com hash - immutable (nunca revalida)
  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Imagens e fontes - cache longo com stale-while-revalidate
  <FilesMatch "\.(webp|avif|png|jpg|jpeg|svg|ico|woff2|woff|mp4|webm)$">
    Header set Cache-Control "public, max-age=31536000, stale-while-revalidate=86400"
  </FilesMatch>

  # Favicon - cache longo
  <FilesMatch "favicon\.(ico|png|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # HTML - sem cache (sempre buscar do servidor)
  <FilesMatch "\.html$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </FilesMatch>

  # JSON (API responses) - sem cache
  <FilesMatch "\.json$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
  </FilesMatch>
</IfModule>

# -----------------------------------------------------------------------------
# COMPRESSÃO
# Nota: Cloudflare já comprime com Brotli/GZIP no edge
# Mantemos aqui como fallback caso o cache expire
# -----------------------------------------------------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE image/svg+xml

  # Não comprimir arquivos já comprimidos
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|avif|woff2|mp4|webm)$ no-gzip
</IfModule>

# -----------------------------------------------------------------------------
# HEADERS DE SEGURANÇA
# Nota: Alguns headers podem ser configurados no Cloudflare também
# Mantemos aqui para garantir que sejam aplicados mesmo em bypass
# -----------------------------------------------------------------------------
<IfModule mod_headers.c>
  # Segurança básica (X-XSS-Protection removido - deprecated)
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # HSTS - Configurado no Cloudflare, mas mantemos como backup
  # Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # Content Security Policy
  Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://www.google-analytics.com https://analytics.google.com https://cloudflareinsights.com https://cms.agenciaharpia.com.br; media-src 'self'; frame-ancestors 'self';"

  # Permissions Policy
  Header set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), interest-cohort=()"

  # Cross-Origin policies
  # Nota: COEP pode causar problemas com recursos do Cloudflare
  Header set Cross-Origin-Opener-Policy "same-origin-allow-popups"
  Header set Cross-Origin-Resource-Policy "same-origin"

  # Remover headers desnecessários
  Header unset X-Powered-By
  Header unset Server
</IfModule>

# -----------------------------------------------------------------------------
# CORS PARA FONTES
# -----------------------------------------------------------------------------
<FilesMatch "\.(woff2?|ttf|otf|eot)$">
  Header set Access-Control-Allow-Origin "*"
</FilesMatch>

# -----------------------------------------------------------------------------
# PRELOAD DE FONTES PRINCIPAIS (melhora LCP)
# -----------------------------------------------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "index\.html$">
    Header add Link "</fonts/dosis/Dosis-Regular.woff2>; rel=preload; as=font; type=font/woff2; crossorigin"
    Header add Link "</fonts/dosis/Dosis-Light.woff2>; rel=preload; as=font; type=font/woff2; crossorigin"
    Header add Link "</fonts/dosis/Dosis-SemiBold.woff2>; rel=preload; as=font; type=font/woff2; crossorigin"
    Header add Link "</fonts/silk-serif/Silk Serif Bold.woff2>; rel=preload; as=font; type=font/woff2; crossorigin"
  </FilesMatch>
</IfModule>

# -----------------------------------------------------------------------------
# EARLY HINTS PARA CLOUDFLARE (103)
# Cloudflare usa esses headers para enviar recursos antes do HTML
# -----------------------------------------------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "index\.html$">
    Header add Link "</assets/index-DVkGzGAv.css>; rel=preload; as=style"
  </FilesMatch>
</IfModule>

# -----------------------------------------------------------------------------
# CACHE PARA SEO FILES
# -----------------------------------------------------------------------------
<FilesMatch "(sitemap\.xml|robots\.txt)$">
  Header set Cache-Control "public, max-age=3600, stale-while-revalidate=86400"
</FilesMatch>

# -----------------------------------------------------------------------------
# OTIMIZAÇÕES EXTRAS
# -----------------------------------------------------------------------------

# Desabilitar listagem de diretórios
Options -Indexes

# Desabilitar server signature
ServerSignature Off

# ETags - Cloudflare gerencia isso, mas mantemos para origin
FileETag MTime Size

# Charset UTF-8
AddDefaultCharset UTF-8

# MIME types corretos
<IfModule mod_mime.c>
  AddType image/avif .avif
  AddType image/webp .webp
  AddType font/woff2 .woff2
  AddType application/manifest+json .webmanifest
</IfModule>
